<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Checkout – K-boxy</title>
    <meta name="description" content="Finalize sua compra na K-boxy e receba sua box misteriosa de K-pop!">

    <link rel="icon" type="image/png" href="images/logo.png">

    <link rel="stylesheet" href="css/style.css">
    <link rel="stylesheet" href="css/minha-conta.css">
    <link rel="stylesheet" href="https://unpkg.com/swiper/swiper-bundle.min.css" />
    <link href="https://unpkg.com/aos@2.3.1/dist/aos.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link
      href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600;700&family=Fredoka+One&display=swap"
      rel="stylesheet"
    >
</head>
<body>

    <div class="preloader">
        <img src="images/logo-k-boxy-anim.svg" alt="K-boxy Logo Animado" class="preloader-logo">
    </div>

    <div id="cepModal" class="modal" style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.5); z-index: 1001; align-items:center; justify-content:center;">
      <div class="modal-content" style="background:#fff; padding:20px; border-radius:8px; max-width:400px; width:90%; text-align:center;">
        <span id="closeCepModal" style="cursor:pointer; float:right; font-size:1.2rem;">&times;</span>
        <h2>Calcular Frete</h2>
        <p style="margin-bottom: 10px;">Precisamos do seu CEP para calcular o valor da entrega.</p>
        <input type="text" id="inputCep" placeholder="CEP (somente números)" style="width:100%; padding:8px; margin:10px 0;">
        <button id="btnCalcFrete" class="btn btn-primary">Calcular</button>
        <p id="freteResult" style="margin-top:10px;"></p>
        <button id="btnConfirmFrete" class="btn btn-primary" disabled>Confirmar Frete</button>
      </div>
    </div>

    <header class="header">
        <div class="container">
            <a href="index.html#home" class="logo">
                <img src="images/logo.png" alt="Logo K-boxy">
            </a>
            <nav class="nav-menu">
                <ul class="nav-list">
                    <li><a href="index.html#home" class="nav-link">Home</a></li>
                    <li><a href="index.html#sobre" class="nav-link">Sobre</a></li>
                    <li><a href="index.html#boxes" class="nav-link">Boxes</a></li>
                    <li><a href="index.html#contato" class="nav-link">Contato</a></li>
                </ul>
            </nav>
            <div class="header-actions">
                <button class="btn btn-primary" onclick="scrollToSection('#boxes')">Compre Agora</button>
                <div class="user-action-container">
                    <button id="login-action-button" class="header-icon-btn" aria-label="Menu do usuário">
                        <i class="fas fa-user-circle"></i>
                    </button>
                    <div id="user-dropdown" class="user-dropdown-menu">
                        <a href="#" id="dropdown-login-link">Login</a>
                        <a href="#" id="dropdown-register-link">Cadastrar</a>
                    </div>
                </div>
                <button class="menu-toggle" id="menu-toggle" aria-label="Abrir menu">
                    <i class="fas fa-bars"></i>
                </button>
            </div>
        </div>
    </header>

    <main class="section-padding" style="padding-top: calc(var(--header-height) + 40px);">
        <div class="container" data-aos="fade-up">
            <h1 class="section-title" style="margin-bottom: 30px;">Checkout</h1>
            <div class="checkout-card"
                 style="background-color: var(--card-bg-color);
                        border-radius: 12px;
                        box-shadow: 0 4px 15px rgba(0,0,0,0.1);
                        padding: 30px;
                        max-width: 600px;
                        margin: 0 auto;
                        text-align: center;">
                <p id="chosenPlanText"
                   style="font-size: 1.2rem;
                          margin-bottom: 25px;
                          color: var(--dark-color);">
                    Carregando informações do plano…
                </p>
                <button id="payButton" class="btn btn-primary btn-large">
                    Ir para pagamento
                </button>
            </div>
        </div>
    </main>

    <footer class="footer">
        <div class="container">
            <div class="footer-content">
                <div class="footer-about">
                    <h3 class="footer-logo">K-boxy ✨</h3>
                    <p>Sua dose mensal de felicidade K-Pop!</p>
                    <p>&copy; <span id="currentYear"></span> K-boxy. Todos os direitos reservados.</p>
                </div>
                <div class="footer-links">
                    <h4>Links Rápidos</h4>
                    <ul>
                        <li><a href="#sobre">Sobre Nós</a></li>
                        <li><a href="#boxes">Nossas Boxes</a></li>
                        <li><a href="#">FAQ</a></li>
                        <li><a href="#">Política de Privacidade</a></li>
                    </ul>
                </div>
              <div class="footer-social">
    <h4>Siga-nos</h4>
    <a href="https://www.instagram.com/kboxy2025?igsh=bHgzODYxc2dvc3U4" target="_blank" aria-label="Instagram K-boxy"><i class="fab fa-instagram"></i></a>
    <a href="#" target="_blank" aria-label="TikTok K-boxy"><i class="fab fa-tiktok"></i></a>
    <a href="https://www.facebook.com/share/19CHKG6iLG/" target="_blank" aria-label="Facebook K-boxy"><i class="fab fa-facebook"></i></a>
    <a href="#" target="_blank" aria-label="Twitter K-boxy"><i class="fab fa-twitter"></i></a>
</div>
            </div>
        </div>
    </footer>

    <button id="back-to-top" class="back-to-top-btn" title="Voltar ao topo">
        <i class="fas fa-arrow-up"></i>
    </button>

    <script src="https://unpkg.com/aos@2.3.1/dist/aos.js"></script>
    <script src="https://unpkg.com/swiper/swiper-bundle.min.js"></script>
    <script src="js/script.js"></script>

    <script>
      document.addEventListener('DOMContentLoaded', function() {
        // 1) Lê os parâmetros da URL para identificar o plano e a box.
        const params = new URLSearchParams(window.location.search);
        const planId = params.get('planId') || params.get('plan') || 'Não definido';
        const boxType = params.get('boxType') || null;
        
        // 2) Inicializa variáveis
        let displayText = '';
        let unitPrice = 0;
        let duration = 1;

        // 3) Define os detalhes do plano com base no ID
        switch (planId) {
          case 'firstLove':
            displayText = 'K-BOXY First Love – Compra Única';
            unitPrice   = 69.90;
            duration    = 1;
            break;
          case 'miniKBoxyPromo':
            displayText = 'Mini K-BOXY – Compra Única';
            unitPrice   = 30.00;
            duration    = 1;
            break;
          case 'fl_semi_annual':
            displayText = 'K-BOXY First Love – Plano Semestral';
            unitPrice   = 54.90;
            duration    = 6;
            break;
          case 'fl_annual':
            displayText = 'K-BOXY First Love – Plano Anual';
            unitPrice   = 49.90;
            duration    = 12;
            break;
          case 'idolBox':
            displayText = 'K-BOXY Lover – Compra Única';
            unitPrice   = 79.90;
            duration    = 1;
            break;
          case 'il_semi_annual':
            displayText = 'K-BOXY Lover – Plano Semestral';
            unitPrice   = 64.90;
            duration    = 6;
            break;
          case 'il_annual':
            displayText = 'K-BOXY Lover – Plano Anual';
            unitPrice   = 59.90;
            duration    = 12;
            break;
          case 'legendBox':
            displayText = 'K-BOXY True Love – Compra Única';
            unitPrice   = 99.90;
            duration    = 1;
            break;
          case 'tl_semi_annual':
            displayText = 'K-BOXY True Love – Plano Semestral';
            unitPrice   = 84.90;
            duration    = 6;
            break;
          case 'tl_annual':
            displayText = 'K-BOXY True Love – Plano Anual';
            unitPrice   = 79.90;
            duration    = 12;
            break;
          default:
            displayText = 'Plano não definido';
            unitPrice   = 0.00;
            duration    = 1;
        }

        // 4) Atualiza o texto na tela
        let chosenText = '';
        if (displayText !== 'Plano não definido') {
            if (duration === 1) {
                chosenText = `${displayText} – R$ ${unitPrice.toFixed(2)}`;
            } else {
                chosenText = `${displayText} – R$ ${unitPrice.toFixed(2)} por mês`;
            }
        } else {
            chosenText = 'Plano não selecionado. Por favor, volte e escolha uma box.';
        }
        document.getElementById('chosenPlanText').textContent = chosenText;

        // 5) Configura modal e frete
        const cepModal      = document.getElementById('cepModal');
        const closeCepModal = document.getElementById('closeCepModal');
        const btnCalcFrete  = document.getElementById('btnCalcFrete');
        const btnConfirmFrete = document.getElementById('btnConfirmFrete');
        const payButton     = document.getElementById('payButton');
        const freteResult   = document.getElementById('freteResult');
        let valorFrete      = 0;

        // ALTERAÇÃO 1: Desabilitar botão de pagamento e mostrar o modal ao carregar a página.
        payButton.disabled = true;
        payButton.textContent = 'Calcule o frete para continuar';
        if (displayText !== 'Plano não definido') {
            cepModal.style.display = 'flex';
        }

        closeCepModal.addEventListener('click', () => {
          cepModal.style.display = 'none';
          // O botão de pagamento continuará desabilitado. O usuário precisa clicar nele
          // (que irá reabrir o modal) ou recarregar a página para tentar de novo.
        });

        btnCalcFrete.addEventListener('click', async () => {
          btnCalcFrete.disabled = true;
          freteResult.textContent = 'Calculando...';
          const cep = document.getElementById('inputCep').value.replace(/\D/g, '');
          
          try {
            const res = await fetch('/api/frete', {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify({ cep })
            });
            const data = await res.json();
            if (data.frete != null) {
              valorFrete = data.frete;
              freteResult.textContent = `Frete: R$ ${valorFrete.toFixed(2)}`;
              btnConfirmFrete.disabled = false;
            } else {
              throw new Error('Não foi possível obter o valor do frete.');
            }
          } catch(err) {
              console.error('Erro ao calcular frete:', err);
              freteResult.textContent = 'Erro ao calcular frete. Tente novamente.';
          } finally {
            btnCalcFrete.disabled = false;
          }
        });

        // ALTERAÇÃO 2: Lógica de confirmação do frete
        btnConfirmFrete.addEventListener('click', () => {
          const totalAmount = unitPrice + valorFrete;
          let newDisplayText = '';
          
          if (duration === 1) {
              newDisplayText = `${displayText} + Frete – Total: R$ ${totalAmount.toFixed(2)}`;
          } else {
              newDisplayText = `${displayText.replace(' por mês', '')} + Frete – Total: R$ ${totalAmount.toFixed(2)} por mês`;
          }
          
          document.getElementById('chosenPlanText').innerHTML = `
              ${newDisplayText}<br>
              <small style="font-size: 0.9rem;">(Plano: R$ ${unitPrice.toFixed(2)} + Frete: R$ ${valorFrete.toFixed(2)})</small>
          `;

          cepModal.style.display = 'none';
          payButton.disabled = false;
          payButton.textContent = 'Ir para pagamento';
        });

        // 6) Evento do botão de pagamento, agora com o fluxo de frete modificado
        payButton.addEventListener('click', async function() {
          // ALTERAÇÃO 3: Se o frete não foi confirmado, abre o modal novamente.
          if (valorFrete === 0 && !this.disabled) {
            alert('Por favor, calcule e confirme o frete para continuar.');
            cepModal.style.display = 'flex';
            return;
          }

          const token = localStorage.getItem('authToken');

          if (!token) {
            alert('Você precisa estar logado para continuar o pagamento.');
            // Opcional: redirecionar para login
            // window.location.href = 'login.html'; 
            return;
          }

          this.textContent = 'Verificando dados...';
          this.disabled = true;

          try {
            // ETAPA 1: Verificar dados do usuário
            const userResponse = await fetch('/api/users/me', {
              headers: { 'Authorization': token }
            });
            if (!userResponse.ok) {
              throw new Error('Não foi possível verificar seus dados. Tente fazer login novamente.');
            }
            const userData = await userResponse.json();
            const address = userData.address;

            // ETAPA 2: Checar endereço completo
            if (!userData.name || !address.street || !address.city || !address.state || !address.zipcode) {
              alert('Por favor, complete seu nome e endereço na sua conta antes de continuar.');
              window.location.href = 'minha-conta.html';
              return;
            }

            // ETAPA 3: Criar preferência de pagamento com frete incluso
            this.textContent = 'Aguarde...';
            
            // O título agora reflete o valor total para clareza no MP
            const finalTitle = `${displayText} (Plano + Frete)`;
            const finalPrice = parseFloat((unitPrice + valorFrete).toFixed(2));
            
            const paymentResponse = await fetch('/api/payment/create_preference', {
              method: 'POST',
              headers: {
                'Content-Type': 'application/json',
                'Authorization': token
              },
              body: JSON.stringify({
                boxType: boxType,
                planId: planId,
                price: finalPrice, // Envia o preço já somado
                title: finalTitle,
                duration: duration
              })
            });

            const paymentData = await paymentResponse.json();
            if (!paymentResponse.ok) {
              throw new Error(paymentData.error || 'Não foi possível criar a preferência de pagamento.');
            }

            // ETAPA 4: Redirecionar para o Mercado Pago
            window.location.href = paymentData.checkoutUrl;

          } catch (err) {
            console.error('Erro no processo de checkout:', err);
            alert('Houve um erro: ' + err.message);
            this.textContent = 'Ir para pagamento';
            this.disabled = false; // Reabilita em caso de erro
          }
        });

      });
    </script>
    </body>
</html>